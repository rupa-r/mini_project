<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>ChatBot</title>
    <!-- add icon link -->
    <link rel="icon" href="/public/css/bot.png" type="image/x-icon">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/3.5.0/mdb.min.css" rel="stylesheet" />
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/3.5.0/mdb.min.js"></script>
</head>
<header>
    <nav class="navbar navbar-expand-lg navbar-light bg-light shadow">
        <div class="container-fluid m-2">
            <!-- <a href="https://imgbb.com/"><img src="https://i.ibb.co/5WJd7mF/bot.png" alt="bot" border="0"></a> -->
            <img src="https://i.ibb.co/WD0pLb3/head-logo.png" style="width: 150px; height: 50px;" alt="logo" class="brand__logo" />
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarTogglerDemo03" aria-controls="navbarTogglerDemo03" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
            <div class="collapse navbar-collapse" id="navbarTogglerDemo03">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="#">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="/views/login">Docs</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="#">Teams</a>
                    </li>
                </ul>
                <form class="d-flex">
                    <a href="/sessionLogout"> <button type="button" class="btn" style="border-radius: 50px; background-color: #a4508b;
                        background-image: linear-gradient(326deg, #a4508b 0%, #5f0a87 74%);color: white;
                        height: 45px;">Log out</button>
                    </a>
                </form>
            </div>
        </div>
    </nav>
</header>

<body>
    <div class="chat">
        <div class="chat-title card-header">
            <h1>Smart BOt</h1>
            <h2>i am customer support chat bot</h2>
            <figure class="avatar">
                <img src="/public/css/bot.png" /></figure>
        </div>
        <div class="messages">
            <div class="messages-content"></div>
            <div class="suggession">

            </div>
        </div>
        <form class="message-box d-flex p-2" id="mymsg" method="POST">
            <input type="text" id="MSG" name="MSG" class="message-input p-4" style="background-color: rgb(211, 216, 214); border-radius: 50px;" placeholder="Type message..."> <i class="fas fa-microphone" id="start-record-btn"></i>
            <button type="submit" class="message-submit">Send</button>
        </form>
        <h3 class="no-browser-support" hidden>Sorry, Your Browser Doesn't Support the Web Speech API. Try Opening This Demo In Google Chrome.</h3>
    </div>
    <div class="bg"></div>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.3/jquery.mCustomScrollbar.concat.min.js'></script>
    <script>
        var $messages = $('.messages-content');
        var serverResponse = "wala";

        var suggession;
        //speech reco
        try {
            var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            var recognition = new SpeechRecognition();
        } catch (e) {
            console.error(e);
            $('.no-browser-support').show();
        }

        $('#start-record-btn').on('click', function(e) {
            recognition.start();
        });

        recognition.onresult = (event) => {
            const speechToText = event.results[0][0].transcript;
            document.getElementById("MSG").value = speechToText;
            //console.log(speechToText)
            insertMessage()
        }


        function listendom(no) {
            console.log(no)
                //console.log(document.getElementById(no))
            document.getElementById("MSG").value = no.innerHTML;
            insertMessage();
        }

        $(window).load(function() {
            $messages.mCustomScrollbar();
            setTimeout(function() {
                serverMessage("hello i am customer support bot type hi and i will show you quick buttons");
            }, 100);

        });

        function updateScrollbar() {
            $messages.mCustomScrollbar("update").mCustomScrollbar('scrollTo', 'bottom', {
                scrollInertia: 10,
                timeout: 0
            });
        }

        function insertMessage() {
            msg = $('.message-input').val();
            if ($.trim(msg) == '') {
                return false;
            }
            $('<div class="message message-personal">' + msg + '</div>').appendTo($('.mCSB_container')).addClass('new');
            fetchmsg()

            $('.message-input').val(null);
            updateScrollbar();

        }

        document.getElementById("mymsg").onsubmit = (e) => {
            e.preventDefault()
            insertMessage();
        }

        function serverMessage(response2) {


            if ($('.message-input').val() != '') {
                return false;
            }
            $('<div class="message loading new"><figure class="avatar"><img src="/public/css/bot.png" /></figure><span></span></div>').appendTo($('.mCSB_container'));
            updateScrollbar();


            setTimeout(function() {
                $('.message.loading').remove();
                $('<div class="message new"><figure class="avatar"><img src="/public/css/bot.png" /></figure>' + response2 + '</div>').appendTo($('.mCSB_container')).addClass('new');
                updateScrollbar();
            }, 100 + (Math.random() * 20) * 100);

        }


        function fetchmsg() {

            var url = 'http://localhost:5000/send-msg';

            const data = new URLSearchParams();
            for (const pair of new FormData(document.getElementById("mymsg"))) {
                data.append(pair[0], pair[1]);
            }

            console.log("abc", data)
            fetch(url, {
                    method: 'POST',
                    body: data
                }).then(res => res.json())
                .then(response => {
                    console.log(response);
                    serverMessage(response.Reply);
                    speechSynthesis.speak(new SpeechSynthesisUtterance(response.Reply))


                })
                .catch(error => console.error('Error h:', error));

        }
    </script>
</body>

</html>